name: PR Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, develop]

jobs:
  code-review:
    name: Comprehensive Code Review
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [22.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better diff analysis
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run Quality Gates
      run: |
        chmod +x scripts/quality-gates/*.sh
        bash scripts/quality-gates/pre-merge.sh || exit 1
      
    - name: Check Contact Information
      id: contact-check
      run: |
        echo "üîç Checking contact information accuracy..."
        
        ERROR_FOUND=false
        
        # Check for incorrect name variations
        if grep -r "Janet" app/ --exclude-dir=node_modules 2>/dev/null | grep -v "node_modules" > /dev/null; then
          echo "‚ùå Found 'Janet' - should be 'Dr. Jan Duffy'"
          grep -r "Janet" app/ --exclude-dir=node_modules 2>/dev/null | head -5 || true
          ERROR_FOUND=true
        fi
        
        # Check for placeholder phone numbers
        if grep -r "555-0100\|555-0000" app/ 2>/dev/null > /dev/null; then
          echo "‚ùå Found placeholder phone numbers"
          grep -r "555-0100\|555-0000" app/ 2>/dev/null | head -5 || true
          ERROR_FOUND=true
        fi
        
        # Check for incorrect "Reference" spelling
        if grep -ri "Reference Summerlin" app/ --exclude-dir=node_modules 2>/dev/null > /dev/null; then
          echo "‚ùå Found 'Reference Summerlin' - should be 'Reverence Summerlin'"
          grep -ri "Reference Summerlin" app/ --exclude-dir=node_modules 2>/dev/null | head -5 || true
          ERROR_FOUND=true
        fi
        
        if [ "$ERROR_FOUND" = "true" ]; then
          echo "error=true" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "‚úÖ Contact information checks passed"
          echo "error=false" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
      
    - name: Check Required Files
      run: |
        echo "üîç Checking required files..."
        
        if [ ! -f "public/sitemap.xml" ] && [ ! -f "app/routes/api/sitemap.tsx" ]; then
          echo "‚ö†Ô∏è  Warning: Sitemap not found in expected locations"
        fi
        
        if [ ! -f "public/robots.txt" ]; then
          echo "‚ö†Ô∏è  Warning: robots.txt not found"
        fi
        
        echo "‚úÖ Required files check complete"
      continue-on-error: true
      
    - name: Check for Console Statements
      run: |
        echo "üîç Checking for console.log statements..."
        
        CONSOLE_COUNT=$(grep -r "console\.log\|console\.debug" app/ --exclude-dir=node_modules | grep -v "// TODO\|// FIXME\|test" | wc -l || echo "0")
        
        if [ "$CONSOLE_COUNT" -gt 0 ]; then
          echo "‚ö†Ô∏è  Warning: Found $CONSOLE_COUNT console.log/debug statements"
          grep -r "console\.log\|console\.debug" app/ --exclude-dir=node_modules | grep -v "// TODO\|// FIXME\|test" || true
          echo "üí° Tip: Remove console statements or replace with proper logging"
        else
          echo "‚úÖ No console.log statements found"
        fi
      continue-on-error: true
      
    - name: Security Check
      run: |
        echo "üîç Running security checks..."
        
        # Check for potential secrets (basic check)
        if grep -ri "api[_-]key.*=.*['\"][a-zA-Z0-9]{20,}" app/ --exclude-dir=node_modules > /dev/null 2>&1; then
          echo "‚ùå Potential hardcoded API key found"
          exit 1
        fi
        
        if grep -ri "password.*=.*['\"][^'\"]{8,}" app/ --exclude-dir=node_modules > /dev/null 2>&1; then
          echo "‚ùå Potential hardcoded password found"
          exit 1
        fi
        
        echo "‚úÖ Basic security checks passed"
      continue-on-error: true
      
    - name: Comment PR Review Summary
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const contactCheck = '${{ steps.contact-check.outcome }}';
          const qualityGates = '${{ job.status }}';
          
          let comment = '## ü§ñ Automated Code Review Results\n\n';
          
          if (qualityGates === 'success') {
            comment += '‚úÖ **Quality Gates:** All checks passed\n';
          } else {
            comment += '‚ùå **Quality Gates:** Some checks failed\n';
          }
          
          if (contactCheck === 'success') {
            comment += '‚úÖ **Contact Information:** Verified correct\n';
          } else if (contactCheck === 'failure') {
            comment += '‚ùå **Contact Information:** Issues detected (see logs)\n';
          }
          
          comment += '\n### üìã Review Checklist\n';
          comment += '- [ ] Code follows project patterns\n';
          comment += '- [ ] Contact info verified: Dr. Jan Duffy, (702) 930-8222, S.0197614.LLC\n';
          comment += '- [ ] No console.log statements in production code\n';
          comment += '- [ ] Images have alt text\n';
          comment += '- [ ] Mobile responsiveness tested\n';
          comment += '\nüìñ See [PRE_MERGE_CHECKLIST.md](PRE_MERGE_CHECKLIST.md) for full checklist\n';
          
          // Find existing bot comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('Automated Code Review Results')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }
          
    - name: Fail if blocking issues found
      if: steps.contact-check.outcome == 'failure' || job.status == 'failure'
      run: |
        echo "‚ùå Code review failed - please fix blocking issues before merging"
        exit 1
